---
import MainLayout from '../layouts/MainLayout.astro';

// 1. Check if user is logged in
if (!Astro.locals.user) {
  return Astro.redirect('/login');
}

// 2. Fetch User Data (Astro.locals.user should have it)
const user = Astro.locals.user;
const profile = user.profile || {}; // Ensure profile object exists

let initialDisplayName = profile.displayName || user.username; // Fallback to username if displayName is not set
let initialBio = profile.bio || '';

// Get messages from URL query parameters
const urlParams = new URLSearchParams(Astro.url.search);
const message = urlParams.get('message');
const error = urlParams.get('error');

let statusMessage = '';
let statusMessageType = ''; // 'success' or 'error'

if (message) {
  statusMessageType = 'success';
  if (message === 'email_verified_successfully') {
    statusMessage = 'Your email has been successfully verified!';
    // Potentially update user object if it's not reflecting the change yet,
    // though a page reload or re-fetch from /api/auth/me would be more robust
    if (user && !user.isEmailVerified) user.isEmailVerified = true;
  } else if (message === 'profile_updated') {
    statusMessage = 'Profile updated successfully!';
  } else {
    statusMessage = decodeURIComponent(message);
  }
} else if (error) {
  statusMessageType = 'error';
  if (error === 'verification_failed_or_expired') {
    statusMessage = 'Email verification failed. The link may be invalid or expired.';
  } else if (error === 'verification_update_failed') {
    statusMessage = 'There was an issue updating your email verification status. Please try again or contact support.';
  } else if (error === 'verification_error') {
    statusMessage = 'An unexpected error occurred during email verification. Please try again.';
  } else {
    statusMessage = decodeURIComponent(error);
  }
}
---

<MainLayout title="User Profile">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6 text-center">Your Profile</h1>

    {statusMessage && (
      <div class:list={[
        "max-w-md mx-auto p-4 mb-4 text-sm rounded-lg",
        statusMessageType === 'success' ? "bg-green-100 text-green-700" : "",
        statusMessageType === 'error' ? "bg-red-100 text-red-700" : ""
      ]} role="alert">
        {statusMessage}
      </div>
    )}

    <div class="max-w-md mx-auto bg-white shadow-md rounded-lg p-6">
      <div class="mb-4">
        <p><strong>Username:</strong> {user.username}</p>
        <p><strong>Email:</strong> {user.email}</p>
        <p>
          <strong>Email Status:</strong>
          {user.isEmailVerified ? (
            <span class="text-green-600 font-semibold">Verified</span>
          ) : (
            <>
              <span class="text-red-600 font-semibold">Not Verified</span>
              <button id="resendVerificationBtn" class="ml-2 text-sm text-blue-600 hover:underline focus:outline-none">
                Resend verification email
              </button>
            </>
          )}
        </p>
        <p><strong>Display Name:</strong> <span id="currentDisplayName">{initialDisplayName}</span></p>
        <p><strong>Bio:</strong> <span id="currentBio">{initialBio || 'No bio set.'}</span></p>
        {user.createdAt && <p><strong>Joined:</strong> {new Date(user.createdAt).toLocaleDateString()}</p>}
        {user.updatedAt && <p><strong>Last Updated:</strong> {new Date(user.updatedAt).toLocaleString()}</p>}
        <p><strong>Credits:</strong> {Astro.locals.user?.credits ?? 0}</p>
      </div>

      <h2 class="text-2xl font-semibold mb-4">Update Profile</h2>
      <form id="profileUpdateForm" class="space-y-4">
        <div>
          <label for="displayName" class="block text-sm font-medium text-gray-700">Display Name:</label>
          <input type="text" id="displayName" name="displayName" value={initialDisplayName} class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        </div>
        <div>
          <label for="bio" class="block text-sm font-medium text-gray-700">Bio:</label>
          <textarea id="bio" name="bio" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">{initialBio}</textarea>
        </div>
        <div>
          <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Update Profile
          </button>
        </div>
      </form>
      <div id="messageArea" class="mt-4 text-sm"></div>
    </div>

    <!-- RAG Ingestion Section -->
    {Astro.locals.user && (
      <div class="max-w-md mx-auto bg-white shadow-md rounded-lg p-6 mt-8">
        <h2 class="text-2xl font-semibold mb-4">Add to Knowledge Base</h2>

        <!-- File Upload Form -->
        <form id="fileUploadForm" class="space-y-4 mb-6">
          <h3 class="text-xl font-medium mb-2">Upload File</h3>
          <div>
            <label for="knowledgeFile" class="block text-sm font-medium text-gray-700">Knowledge File:</label>
            <input type="file" id="knowledgeFile" name="knowledgeFile" class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
            <p class="mt-1 text-sm text-gray-500">Upload a file to add its content to the knowledge base.</p>
          </div>
          <div>
            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
              Upload File
            </button>
          </div>
          <div id="fileUploadMessage" class="mt-2 text-sm"></div>
        </form>

        <!-- URL Ingestion Form -->
        <form id="urlIngestionForm" class="space-y-4 mb-6">
          <h3 class="text-xl font-medium mb-2">Ingest from URL</h3>
          <div>
            <label for="knowledgeUrl" class="block text-sm font-medium text-gray-700">Knowledge URL:</label>
            <input type="url" id="knowledgeUrl" name="knowledgeUrl" placeholder="https://example.com/article" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          </div>
          <div>
            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
              Ingest URL
            </button>
          </div>
          <div id="urlIngestionMessage" class="mt-2 text-sm"></div>
        </form>

        <!-- Text Input Form -->
        <form id="textIngestionForm" class="space-y-4">
          <h3 class="text-xl font-medium mb-2">Ingest Text</h3>
          <div>
            <label for="knowledgeTitle" class="block text-sm font-medium text-gray-700">Title (Optional):</label>
            <input type="text" id="knowledgeTitle" name="knowledgeTitle" placeholder="My Document Title" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          </div>
          <div>
            <label for="knowledgeText" class="block text-sm font-medium text-gray-700">Text Content:</label>
            <textarea id="knowledgeText" name="knowledgeText" rows="5" placeholder="Paste your text content here..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
          </div>
          <div>
            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
              Ingest Text
            </button>
          </div>
          <div id="textIngestionMessage" class="mt-2 text-sm"></div>
        </form>
      </div>
    )}
  </div>
</MainLayout>

<script>
  const form = document.getElementById('profileUpdateForm');
  const messageArea = document.getElementById('messageArea');
  const currentDisplayNameElement = document.getElementById('currentDisplayName');
  const currentBioElement = document.getElementById('currentBio');
  const resendBtn = document.getElementById('resendVerificationBtn');

  // Function to display messages in the main status area at the top
  function showStatusMessage(text, type = 'info') {
    const statusDiv = document.querySelector('div[role="alert"]'); // Find existing or create new
    let newStatusDiv = statusDiv;
    if (!newStatusDiv) {
        newStatusDiv = document.createElement('div');
        newStatusDiv.setAttribute('role', 'alert');
        const mainContentDiv = document.querySelector('.container > .max-w-md.mx-auto.bg-white'); // insert before this
        if (mainContentDiv) {
            mainContentDiv.parentNode.insertBefore(newStatusDiv, mainContentDiv);
        } else {
            // fallback if structure changes
            document.querySelector('.container').prepend(newStatusDiv);
        }
    }
    newStatusDiv.textContent = text;
    newStatusDiv.className = "max-w-md mx-auto p-4 mb-4 text-sm rounded-lg"; // Reset classes
    if (type === 'success') {
      newStatusDiv.classList.add('bg-green-100', 'text-green-700');
    } else if (type === 'error') {
      newStatusDiv.classList.add('bg-red-100', 'text-red-700');
    } else { // info or default
      newStatusDiv.classList.add('bg-blue-100', 'text-blue-700');
    }
  }


  if (resendBtn) {
    resendBtn.addEventListener('click', async () => {
      resendBtn.disabled = true;
      resendBtn.textContent = 'Sending...';
      messageArea.textContent = ''; // Clear profile update messages
      messageArea.className = 'mt-4 text-sm';

      try {
        const response = await fetch('/api/auth/resend-verification-email', {
          method: 'POST',
        });
        const result = await response.json();

        if (response.ok) {
          showStatusMessage(result.message || 'Verification email sent!', 'success');
        } else {
          showStatusMessage(`Error: ${result.message || 'Failed to resend email.'}`, 'error');
        }
      } catch (err) {
        console.error('Resend verification error:', err);
        showStatusMessage('An unexpected error occurred. Please try again.', 'error');
      } finally {
        resendBtn.disabled = false;
        resendBtn.textContent = 'Resend verification email';
      }
    });
  }

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    messageArea.textContent = '';
    messageArea.className = 'mt-4 text-sm'; // Reset classes

    const formData = new FormData(form);
    const displayName = formData.get('displayName');
    const bio = formData.get('bio');

    try {
      const response = await fetch('/api/auth/profile', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ displayName, bio }),
      });

      const result = await response.json();

      if (response.ok) {
        messageArea.textContent = result.message || 'Profile updated successfully!';
        messageArea.classList.add('text-green-600');
        // Update displayed values
        if (result.user && result.user.profile) {
          currentDisplayNameElement.textContent = result.user.profile.displayName || result.user.username;
          currentBioElement.textContent = result.user.profile.bio || 'No bio set.';
          // Optionally update form input values if needed, though a page refresh might be simpler for full sync
          document.getElementById('displayName').value = result.user.profile.displayName || result.user.username;
          document.getElementById('bio').value = result.user.profile.bio || '';
        } else if (result.user) {
            currentDisplayNameElement.textContent = result.user.username; // Fallback if profile object is missing after update
        }
      } else {
        messageArea.textContent = `Error: ${result.message || 'Failed to update profile.'}`;
        messageArea.classList.add('text-red-600');
      }
    } catch (error) {
      console.error('Update profile error:', error);
      messageArea.textContent = 'An unexpected error occurred. Please try again.';
      messageArea.classList.add('text-red-600');
    }
  });

  // RAG Ingestion Forms
  const fileUploadForm = document.getElementById('fileUploadForm');
  const fileUploadMessage = document.getElementById('fileUploadMessage');
  const urlIngestionForm = document.getElementById('urlIngestionForm');
  const urlIngestionMessage = document.getElementById('urlIngestionMessage');
  const textIngestionForm = document.getElementById('textIngestionForm');
  const textIngestionMessage = document.getElementById('textIngestionMessage');

  // Helper to display messages for RAG forms
  function showRagMessage(element, message, type = 'info') {
    element.textContent = message;
    element.className = 'mt-2 text-sm'; // Reset classes
    if (type === 'success') {
      element.classList.add('text-green-600');
    } else if (type === 'error') {
      element.classList.add('text-red-600');
    } else {
      element.classList.add('text-blue-700');
    }
  }

  if (fileUploadForm) {
    fileUploadForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      showRagMessage(fileUploadMessage, 'Uploading...', 'info');
      const formData = new FormData(fileUploadForm);
      const submitButton = fileUploadForm.querySelector('button[type="submit"]');
      submitButton.disabled = true;

      try {
        const response = await fetch('/api/rag/ingest/upload', {
          method: 'POST',
          body: formData,
        });
        const result = await response.json();
        if (response.ok) {
          showRagMessage(fileUploadMessage, result.message || 'File uploaded successfully!', 'success');
          fileUploadForm.reset();
        } else {
          showRagMessage(fileUploadMessage, `Error: ${result.message || 'File upload failed.'}`, 'error');
        }
      } catch (error) {
        console.error('File upload error:', error);
        showRagMessage(fileUploadMessage, 'An unexpected error occurred.', 'error');
      } finally {
        submitButton.disabled = false;
      }
    });
  }

  if (urlIngestionForm) {
    urlIngestionForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const knowledgeUrl = document.getElementById('knowledgeUrl').value;
      if (!knowledgeUrl) {
        showRagMessage(urlIngestionMessage, 'Please enter a URL.', 'error');
        return;
      }
      showRagMessage(urlIngestionMessage, 'Ingesting URL...', 'info');
      const submitButton = urlIngestionForm.querySelector('button[type="submit"]');
      submitButton.disabled = true;

      try {
        const response = await fetch('/api/rag/ingest/url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: knowledgeUrl }),
        });
        const result = await response.json();
        if (response.ok) {
          showRagMessage(urlIngestionMessage, result.message || 'URL ingested successfully!', 'success');
          urlIngestionForm.reset();
        } else {
          showRagMessage(urlIngestionMessage, `Error: ${result.message || 'URL ingestion failed.'}`, 'error');
        }
      } catch (error) {
        console.error('URL ingestion error:', error);
        showRagMessage(urlIngestionMessage, 'An unexpected error occurred.', 'error');
      } finally {
        submitButton.disabled = false;
      }
    });
  }

  if (textIngestionForm) {
    textIngestionForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const knowledgeTitle = document.getElementById('knowledgeTitle').value;
      const knowledgeText = document.getElementById('knowledgeText').value;

      if (!knowledgeText) {
        showRagMessage(textIngestionMessage, 'Please enter text content.', 'error');
        return;
      }
      showRagMessage(textIngestionMessage, 'Ingesting text...', 'info');
      const submitButton = textIngestionForm.querySelector('button[type="submit"]');
      submitButton.disabled = true;

      try {
        const response = await fetch('/api/rag/ingest/text', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: knowledgeTitle, text: knowledgeText }),
        });
        const result = await response.json();
        if (response.ok) {
          showRagMessage(textIngestionMessage, result.message || 'Text ingested successfully!', 'success');
          textIngestionForm.reset();
        } else {
          showRagMessage(textIngestionMessage, `Error: ${result.message || 'Text ingestion failed.'}`, 'error');
        }
      } catch (error) {
        console.error('Text ingestion error:', error);
        showRagMessage(textIngestionMessage, 'An unexpected error occurred.', 'error');
      } finally {
        submitButton.disabled = false;
      }
    });
  }
</script>